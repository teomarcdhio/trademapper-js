#!/usr/bin/env node
// Convert openflights (https://openflights.org/data.html#airport) CSV file to JS;
// at a minimum, the CSV to process needs "ICAO Code" and "IATA Code" columns.
//
// This builds an object with a "icao" and "iata" properties; each of those is
// an object with the port codes as keys from the relevant vocabulary. The
// values for icao are the properties of the port, while the iata codes just
// map to the icao codes.
//
// The output is a JS requirejs definition for the ports data
// (see trademapper/map/ports.js for example).

var fs = require('fs');
var process = require('process');
var path = require('path');

var d3 = require('./trademapper/js/lib/d3.min');


var scriptName = path.basename(process.argv[1]);

if (process.argv.length < 3) {
	console.error('Usage: ' + scriptName + ' <path to openflights csv>');
	process.exit(1);
}

var ports = {
	icao: {},
	iata: {},
};

var filepath = process.argv[2];

var csvParser = d3.dsvFormat(',');
var output = csvParser.parse(fs.readFileSync(filepath, 'utf8'))

var icaoCode, iataCode;
for (var i = 0; i < output.length; i++) {
	var port = output[i];

	icaoCode = port['ICAO Code'];
	if (icaoCode !== "\\N") {
		ports.icao[icaoCode] = {
			lat: parseFloat(port['Latitude']),
			lon: parseFloat(port['Longitude']),
			name: port['Name'],
			city: port['City'],
			country: port['Country'],
		};

		iataCode = port['IATA Code'];
		if (iataCode !== "\\N" && iataCode !== 'N/A') {
			ports.iata[iataCode] = icaoCode;
		}
	}
}

console.log('// generated by ' + scriptName + '\ndefine(' + JSON.stringify(ports) + ');');
